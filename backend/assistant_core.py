from groq import Groq
import os
from dotenv import load_dotenv
from typing import Optional, Dict, Any
import logging

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Load environment variables
load_dotenv()
GROQ_API_KEY = os.getenv("GROQ_API_KEY")
DEFAULT_MODEL = "llama3-70b-8192"

# Initialize Groq client
client = None
if GROQ_API_KEY:
    try:
        client = Groq(api_key=GROQ_API_KEY)
        logger.info("‚úÖ Groq client initialized successfully")
    except Exception as e:
        logger.error(f"‚ùå Failed to initialize Groq client: {e}")
        client = None
else:
    logger.warning("‚ö†Ô∏è GROQ_API_KEY not found in environment variables")

# Comprehensive system prompts for different farming scenarios
system_prompts = {
    "Smart Farming Advice": """You are an expert AI farming assistant specializing in agricultural best practices, 
weather-based farming decisions, and sustainable agriculture. You provide practical, actionable advice to farmers 
based on current weather conditions, seasonal patterns, and modern farming techniques.

Your expertise includes:
- Crop selection and timing based on weather forecasts
- Soil management and irrigation strategies
- Pest and disease management
- Sustainable farming practices
- Weather-adaptive farming techniques
- Market timing and crop planning

Always provide specific, practical advice that farmers can implement immediately. Consider local weather conditions, 
seasonal factors, and sustainable practices in your recommendations.""",

    "Weather-Based Farming": """You are a weather-aware farming consultant who helps farmers make decisions based on 
current and forecasted weather conditions. You analyze weather patterns and provide specific recommendations for:

- Planting and harvesting timing
- Irrigation scheduling
- Crop protection measures
- Field preparation activities
- Livestock management during weather events
- Equipment and resource planning

Base your advice on weather data including temperature, rainfall, humidity, and seasonal patterns.""",

    "Crop Management": """You are a crop management specialist providing expert advice on:

- Optimal planting times for different crops
- Crop rotation strategies
- Fertilization and soil management
- Pest and disease prevention
- Harvest timing and techniques
- Post-harvest handling and storage
- Market timing and crop selection

Provide specific, actionable recommendations based on current conditions and best practices.""",

    "Sustainable Agriculture": """You are a sustainable agriculture expert promoting environmentally friendly farming practices:

- Organic farming methods
- Water conservation techniques
- Soil health improvement
- Biodiversity enhancement
- Integrated pest management
- Renewable energy in agriculture
- Waste reduction and recycling
- Climate-smart agriculture

Focus on practices that maintain long-term soil health, reduce environmental impact, and ensure economic viability.""",

    "Emergency Weather Response": """You are an emergency response advisor for weather-related agricultural crises:

- Flood damage assessment and recovery
- Drought mitigation strategies
- Storm damage prevention and repair
- Heat stress management for crops and livestock
- Emergency crop protection measures
- Resource allocation during weather events
- Insurance and financial planning

Provide immediate, practical steps for farmers facing weather emergencies.""",
}

def generate_response(prompt: str, use_case: str = "Smart Farming Advice") -> str:
    """
    Generate AI-powered farming advice using Groq LLM.
    
    Args:
        prompt (str): User's farming question or concern
        use_case (str): Type of farming advice needed
        
    Returns:
        str: AI-generated response with farming advice
    """
    if not prompt or prompt.strip() == "":
        return "‚ùå Please provide a specific farming question or concern."
    
    # Check if we have a valid client
    if not client or not GROQ_API_KEY or GROQ_API_KEY == "gsk_demo_key_for_testing_only":
        # Return fallback responses for testing
        logger.warning("‚ö†Ô∏è Using fallback responses - no valid API key or client")
        return _get_fallback_response(prompt, use_case)
    
    # Get the appropriate system prompt
    system_prompt = system_prompts.get(use_case, system_prompts["Smart Farming Advice"])
    
    try:
        logger.info(f"ü§ñ Generating response for use case: {use_case}")
        response = client.chat.completions.create(
            model=DEFAULT_MODEL,
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": prompt}
            ],
            max_tokens=1000,
            temperature=0.7
        )
        answer = response.choices[0].message.content if response.choices and response.choices[0].message else None
        if answer is None:
            return "‚ùå No response generated from AI model."
        
        # Check if the answer contains an API key (security check)
        if answer and (answer.startswith("gsk_") or "gsk_" in answer):
            logger.warning("‚ö†Ô∏è API key detected in response - using fallback")
            return _get_fallback_response(prompt, use_case)
        
        logger.info("‚úÖ Response generated successfully")
        return answer
        
    except Exception as e:
        error_msg = f"‚ùå Error generating response: {str(e)}"
        logger.error(error_msg)
        # Return fallback response on error
        return _get_fallback_response(prompt, use_case)

def _get_fallback_response(prompt: str, use_case: str) -> str:
    """
    Provide fallback responses when AI service is unavailable.
    
    Args:
        prompt (str): User's question
        use_case (str): Type of advice needed
        
    Returns:
        str: Fallback response
    """
    prompt_lower = prompt.lower()
    
    # Smart Farming Advice fallbacks
    if "crop" in prompt_lower and "grow" in prompt_lower:
        return """üå± **Crop Growing Advice for Machakos Region:**

**Best Crops for Machakos:**
‚Ä¢ Maize (corn) - Main staple crop
‚Ä¢ Beans - Good for soil nitrogen
‚Ä¢ Sweet potatoes - Drought resistant
‚Ä¢ Sorghum - Heat tolerant
‚Ä¢ Green grams - High value crop

**Planting Tips:**
‚Ä¢ Plant during rainy seasons (March-May, October-December)
‚Ä¢ Use certified seeds for better yields
‚Ä¢ Practice crop rotation to maintain soil health
‚Ä¢ Consider intercropping maize with beans

**Soil Management:**
‚Ä¢ Test soil pH before planting
‚Ä¢ Add organic matter (compost, manure)
‚Ä¢ Use terraces to prevent soil erosion
‚Ä¢ Practice conservation agriculture

üí° **Tip:** Start with maize and beans as they're well-suited for the Machakos climate and soil conditions."""

    elif "weather" in prompt_lower or "rain" in prompt_lower:
        return """üå§Ô∏è **Weather-Based Farming for Machakos:**

**Current Weather Considerations:**
‚Ä¢ Machakos has a semi-arid climate
‚Ä¢ Two rainy seasons: March-May (long rains) and October-December (short rains)
‚Ä¢ Average temperature: 18-25¬∞C
‚Ä¢ Annual rainfall: 600-800mm

**Weather-Adaptive Strategies:**
‚Ä¢ Plant drought-resistant crops (sorghum, millet)
‚Ä¢ Use mulching to retain soil moisture
‚Ä¢ Practice rainwater harvesting
‚Ä¢ Monitor weather forecasts regularly

**Seasonal Planning:**
‚Ä¢ **Long Rains (March-May):** Plant maize, beans, vegetables
‚Ä¢ **Short Rains (October-December):** Plant quick-maturing crops
‚Ä¢ **Dry Seasons:** Focus on irrigation and soil preparation

üåßÔ∏è **Rainwater Harvesting Tips:**
‚Ä¢ Build water pans and dams
‚Ä¢ Use roof catchment systems
‚Ä¢ Practice contour farming
‚Ä¢ Plant trees for windbreaks"""

    elif "soil" in prompt_lower or "fertilizer" in prompt_lower:
        return """üåø **Soil Management & Fertilization:**

**Machakos Soil Characteristics:**
‚Ä¢ Generally sandy loam to clay loam
‚Ä¢ Often low in organic matter
‚Ä¢ pH ranges from 5.5 to 7.0
‚Ä¢ Prone to erosion

**Soil Improvement:**
‚Ä¢ Add organic matter (compost, farmyard manure)
‚Ä¢ Practice crop rotation
‚Ä¢ Use cover crops (pigeon peas, lablab)
‚Ä¢ Implement terracing on slopes

**Fertilization Guide:**
‚Ä¢ **Organic:** Compost, manure, green manure
‚Ä¢ **Inorganic:** NPK fertilizers (17-17-17)
‚Ä¢ **Application:** Apply before planting and during growth
‚Ä¢ **Rate:** Follow soil test recommendations

**Erosion Control:**
‚Ä¢ Build terraces on slopes
‚Ä¢ Plant grass strips
‚Ä¢ Use contour farming
‚Ä¢ Maintain ground cover"""

    elif "pest" in prompt_lower or "disease" in prompt_lower:
        return """ü¶ó **Pest & Disease Management:**

**Common Pests in Machakos:**
‚Ä¢ Fall armyworm (maize)
‚Ä¢ Aphids (beans, vegetables)
‚Ä¢ Cutworms (seedlings)
‚Ä¢ Stalk borers (maize)

**Disease Prevention:**
‚Ä¢ Use disease-resistant varieties
‚Ä¢ Practice crop rotation
‚Ä¢ Remove infected plants
‚Ä¢ Maintain field hygiene

**Natural Pest Control:**
‚Ä¢ Plant repellent crops (marigolds, onions)
‚Ä¢ Use neem extracts
‚Ä¢ Encourage beneficial insects
‚Ä¢ Practice intercropping

**Monitoring:**
‚Ä¢ Regular field inspections
‚Ä¢ Use pheromone traps
‚Ä¢ Monitor weather conditions
‚Ä¢ Keep records of pest outbreaks

üå± **Integrated Pest Management (IPM):**
‚Ä¢ Combine cultural, biological, and chemical methods
‚Ä¢ Use pesticides as last resort
‚Ä¢ Follow safety guidelines
‚Ä¢ Rotate pesticide types"""

    else:
        return f"""ü§ñ **AI Farming Assistant - Demo Mode**

**Your Question:** {prompt}

**Use Case:** {use_case}

**Demo Response:**
This is a demonstration of the AI Farming Assistant. In production, you would receive personalized farming advice based on your specific question and local conditions.

**For Machakos Region, consider:**
‚Ä¢ Semi-arid climate with two rainy seasons
‚Ä¢ Focus on drought-resistant crops
‚Ä¢ Practice soil conservation
‚Ä¢ Use rainwater harvesting
‚Ä¢ Monitor weather forecasts

**To get real AI advice:**
1. Get a GROQ API key from https://console.groq.com/
2. Add it to your .env file
3. Restart the backend server

üí° **Quick Tips:**
‚Ä¢ Plant maize and beans during rainy seasons
‚Ä¢ Use terraces to prevent soil erosion
‚Ä¢ Practice crop rotation
‚Ä¢ Consider drought-resistant varieties

Would you like specific advice about crops, weather, soil, or pest management?"""

def get_available_use_cases() -> Dict[str, str]:
    """
    Get available use cases for the AI assistant.
    
    Returns:
        Dict[str, str]: Dictionary of use case names and descriptions
    """
    return {
        "Smart Farming Advice": "General farming advice and best practices",
        "Weather-Based Farming": "Weather-dependent farming decisions",
        "Crop Management": "Crop-specific advice and management",
        "Sustainable Agriculture": "Environmentally friendly farming practices",
        "Emergency Weather Response": "Emergency response for weather crises"
    }

def test_connectivity() -> Dict[str, Any]:
    """
    Test the AI assistant connectivity and configuration.
    
    Returns:
        Dict[str, Any]: Test results and status information
    """
    result = {
        "api_key_configured": bool(GROQ_API_KEY),
        "client_initialized": bool(client),
        "available_use_cases": list(system_prompts.keys()),
        "default_model": DEFAULT_MODEL,
        "status": "unknown"
    }
    
    if not GROQ_API_KEY:
        result["status"] = "no_api_key"
        result["message"] = "GROQ_API_KEY not found in environment variables"
    elif not client:
        result["status"] = "client_error"
        result["message"] = "Failed to initialize Groq client"
    else:
        try:
            # Test with a simple prompt
            test_response = generate_response("Hello, this is a test message.", "Smart Farming Advice")
            if test_response.startswith("‚ùå"):
                result["status"] = "api_error"
                result["message"] = test_response
            else:
                result["status"] = "working"
                result["message"] = "AI Assistant is working correctly"
        except Exception as e:
            result["status"] = "test_error"
            result["message"] = f"Test failed: {str(e)}"
    
    return result

if __name__ == "__main__":
    # Test the assistant when run directly
    print("üß™ Testing AI Farming Assistant...")
    test_result = test_connectivity()
    print(f"Status: {test_result['status']}")
    print(f"Message: {test_result['message']}")
    
    if test_result['status'] == 'working':
        print("\nüìù Testing response generation...")
        test_response = generate_response(
            "What should I plant this season given the current weather?", 
            "Weather-Based Farming"
        )
        print(f"Response: {test_response}") 